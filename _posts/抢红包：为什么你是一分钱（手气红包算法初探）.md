---
title: 抢红包：为什么你是一分钱（手气红包算法初探）
date: 2016-06-16 18:29:07
tags: 算法
---

## **考神保佑，逢考必过**

![帅](https://raw.githubusercontent.com/jeasonstudio/images/b8122cfa7ae637d1574236bacf8b4ba7e0def119/20160616/shuai.jpg)

## **写在前面**

好像从去年还是前年开始，手气红包就代替了普通红包，在 QQ 、微信群里狂热起来，不可收拾
对于那种每次都是一毛钱发十个的人真是无话可说，还不够我电钱流量钱

但有时候最不能忍的就是明明是个大大滴红包，别人都领了几块钱，而我是几分钱
`偶买噶得恩` 这尼玛简直不能忍

![红包](https://raw.githubusercontent.com/jeasonstudio/images/b8122cfa7ae637d1574236bacf8b4ba7e0def119/20160616/red.jpg)

难不成是上天看我天资聪慧要让我历经磨难？

so。。。。跟我一起研究研究，手气红包到底是个什么鬼。

<!--more-->

## **有问有答**

>Q:手气红包是发出来的时候已经分好了每份多少钱吗？
 A:当然不是，那样有什么手气可言，完全就是看谁先领谁后领的啊，到不如叫脚气红包。
 所以肯定不是领之前分好了，应该是在点击的时候确定的面额。
 
--- 
>Q:红包里的金额怎么算？为什么出现各个红包金额相差很大？
 A:随机，额度在 `0.01` 和 `剩余平均值X2` 之间。(官方)
 
---
>Q:你这么说，结论是从哪得来的呢？
 A:我当然不能是瞎编的，下面这段 java 是来自 `微信`。
   算法不分语言，没学过 Java 也能看懂，不想自己读代码就跳过撒。
   然而善良的我给你们加满了注释（嘘。。。。）

## **干货来袭**

### 算法

```java
public static double getRandomMoney(RedPackage _redPackage) {
    //首先public一个class，也就是整个分手气红包的过程
    // remainSize 剩余的红包数量
    // remainMoney 剩余的钱
    if (_redPackage.remainSize == 1) {
        //如果只剩最后一个红包
        _redPackage.remainSize--;
        //剩余红包个数减一
        return (double) Math.round(_redPackage.remainMoney * 100) / 100;
        //返回double型的值，也就是最后一个红包的面额（换算成元）
    }
    //若剩余红包不止一个
    Random r     = new Random();
    //定义了一个随机数 r 
    //（这里他妈有个坑，谁知道JAVA的随机数是不是伪随机数）先不管，一会再说。
    double min   = 0.01; 
    // 定义红包最小面额是一分钱
    //也就是我抢的最多的那个面额
    double max   = _redPackage.remainMoney / _redPackage.remainSize * 2;
    //定义红包的最大面额是 剩余平均值X2
    double money = r.nextDouble() * max;
    //定义你抢到的钱（money）= 随机数r X 最大值
    //r是 Random 类型的，所以r.nextDouble是一个随机数
    money = money <= min ? 0.01: money;
    //若这个数特么的居然小于0.01，那只能给你一分咯
    //说明你人品可能比你想象的还差
    money = Math.floor(money * 100) / 100;
    //Math.floor的意思是取小于这个浮点数最接近整数
    //这就是你抢到的钱
    _redPackage.remainSize--;
    //红包个数减一
    _redPackage.remainMoney -= money;
    //总钱数扣除
    return money;
    //小手一抖，红包我有
}
```
(鄙人 Java 菜鸡，有错误请指正，3q)

### 数据结构

LeftMoneyPackage数据结构：
```java
class RedPackage {
    int    remainSize;
    double remainMoney;
}
```
### 测试

然后网上的大神有这方面的测试结果，
测试时初始化相关数据是：
```java
static void init() {
    redPackage.remainSize  = 30;
    redPackage.remainMoney = 500;
}
```

## **没图说个卵啊**

第一次：
![01](https://raw.githubusercontent.com/jeasonstudio/images/b8122cfa7ae637d1574236bacf8b4ba7e0def119/20160616/01.png)
第二次：
![02](https://raw.githubusercontent.com/jeasonstudio/images/b8122cfa7ae637d1574236bacf8b4ba7e0def119/20160616/02.png)
多次均值：
![03](https://raw.githubusercontent.com/jeasonstudio/images/b8122cfa7ae637d1574236bacf8b4ba7e0def119/20160616/03.png)
大量数据：
![04](https://raw.githubusercontent.com/jeasonstudio/images/b8122cfa7ae637d1574236bacf8b4ba7e0def119/20160616/04.png)

**可以看出来，其实每个人抢到的钱是大致相等的**
（最后有一点 JAVA 的随机数玄机探秘）

## **大神们说**

**@来源于QCon某高可用架构群整理，整理朱玉华。**

>背景：有某个朋友在朋友圈咨询微信红包的架构，于是乎有了下面的文字（有误请提出，谢谢）
概况：2014年微信红包使用数据库硬抗整个流量，2015年使用cache抗流量。

---
>微信的金额什么时候算？
答：微信金额是拆的时候实时算出来，不是预先分配的，采用的是纯内存计算，不需要预算空间存储。
采取实时计算金额的考虑：预算需要占存储，实时效率很高，预算才效率低。

---
>实时性：为什么明明抢到红包，点开后发现没有？
答：2014年的红包一点开就知道金额，分两次操作，先抢到金额，然后再转账。
2015年的红包的拆和抢是分离的，需要点两次，因此会出现抢到红包了，但点开后告知红包已经被领完的状况。进入到第一个页面不代表抢到，只表示当时红包还有。

---
>分配：红包里的金额怎么算？为什么出现各个红包金额相差很大？
答：随机，额度在0.01和(剩余平均值*2)之间。
例如：发100块钱，总共10个红包，那么平均值是10块钱一个，那么发出来的红包的额度在0.01元～20元之间波动。
当前面3个红包总共被领了40块钱时，剩下60块钱，总共7个红包，那么这7个红包的额度在：0.01～（60/7*2）=17.14之间。
注意：这里的算法是每被抢一个后，剩下的会再次执行上面的这样的算法（Tim老师也觉得上述算法太复杂，不知基于什么样的考虑）。
这样算下去，会超过最开始的全部金额，因此到了最后面如果不够这么算，那么会采取如下算法：保证剩余用户能拿到最低1分钱即可。
如果前面的人手气不好，那么后面的余额越多，红包额度也就越多，因此实际概率一样的。

---
>红包的设计
答：微信从财付通拉取金额数据郭莱，生成个数/红包类型/金额放到redis集群里，app端将红包ID的请求放入请求队列中，如果发现超过红包的个数，直接返回。根据红包的裸祭(逻辑)处理成功得到令牌请求，则由财付通进行一致性调用，通过像比特币一样，两边保存交易记录，交易后交给第三方服务审计，如果交易过程中出现不一致就强制回归。

---
>发性处理：红包如何计算被抢完？
答：cache会抵抗无效请求，将无效的请求过滤掉，实际进入到后台的量不大。cache记录红包个数，原子操作进行个数递减，到0表示被抢光。财付通按照20万笔每秒入账准备，但实际还不到8万每秒。

---
>通如何保持8w每秒的写入？
答：多主sharding，水平扩展机器。

---
>据容量多少？
答：一个红包只占一条记录，有效期只有几天，因此不需要太多空间。

---
>询红包分配，压力大不？
答：抢到红包的人数和红包都在一条cache记录上，没有太大的查询压力。

---
>一个红包一个队列？
答：没有队列，一个红包一条数据，数据上有一个计数器字段。

---
>有没有从数据上证明每个红包的概率是不是均等？
答：不是绝对均等，就是一个简单的拍脑袋算法。

---
>拍脑袋算法，会不会出现两个最佳？
答：会出现金额一样的，但是手气最佳只有一个，先抢到的那个最佳。

---
>每领一个红包就更新数据么？
答：每抢到一个红包，就cas更新剩余金额和红包个数。

---
>红包如何入库入账？
数据库会累加已经领取的个数与金额，插入一条领取记录。入账则是后台异步操作。

---
>入帐出错怎么办？比如红包个数没了，但余额还有？
答：最后会有一个take all操作。另外还有一个对账来保障。

原文链接：[https://www.zybuluo.com/yulin718/note/93148](https://www.zybuluo.com/yulin718/note/93148)

## **Java 随机数**

![suiji](https://raw.githubusercontent.com/jeasonstudio/images/b8122cfa7ae637d1574236bacf8b4ba7e0def119/20160616/suiji.png)

红包归根到底还是取的系统的随机数算法，感觉，没什么意思。
查过资料才知道，`随机数`，只是一种

>利用程序响应时间或当前时间（种子）经过一系列叉叉乘乘的方法（算法）得到一个看起来很随机的数罢了。

其实仔细想想也是，计算机本来就是机器，没有二义性，哪有随机之谈呢。

想深入理解的童鞋请 **点击** [这里(杨中科老师的博客)](http://www.cnblogs.com/rupeng/p/3723018.html)
讲的很深入透彻，还有视频讲解。

## **回首**

**好了，那么，问题解决了吗？**

如果你觉得不过瘾可以看看这位仁兄的仓库：[你确定要点？](https://github.com/liujin834/luckymoney-test.git)

现在你觉得，你的人品渣到爆了吗？

## **写在后面**

马上考试周了，然而我还像个文盲一样，不说了，我要去预习了。

虽然说弄懂这些东西加上写这个博客花了我两个多小时，但我觉得很值

这就够了

看到结尾的都是真爱。